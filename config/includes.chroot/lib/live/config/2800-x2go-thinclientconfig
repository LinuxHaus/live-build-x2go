#!/bin/bash

X2GoThinClientConfig ()
{

# Output startup message
#
echo -n " x2go-thinclientconfig"

sed -i -e '\#<applications>#a<application title="X2Go Client" type="normal">' -e '\#<applications>#a<decor>no</decor>' -e '\#<applications>#a</application>' /etc/xdg/openbox/rc.xml

cat >/home/user/.xsession <<XSESSION
# inspired by 
# http://code.x2go.org/gitweb?p=x2gothinclient.git;a=blob_plain;f=displaymanager/sbin/x2gothinclientd;h=6897d42d17bd6778e7de5e62ec3f51727d4e8800;hb=HEAD
# check the above file for ideas before reinventing the wheel

# Spawn PulseAudio
pulseaudio -D -n -L 'module-native-protocol-tcp port=4713' -L 'module-udev-detect' --exit-idle-time=65535 &

# Spawn openbox
openbox &


# Get X2GoConfig
BROKERURL=\$(cat /proc/cmdline | \
	    tr ' ' '\n' | \
	    awk -F'=' ' /^broker-url=/ { print \$2 }')
LDAP=\$(cat /proc/cmdline | \
	    tr ' ' '\n' | \
	    sed 's/^ldap=/ldap#/' | \
	    awk -F'#' ' /^ldap#/ { print \$2 }')
LDAP1=\$(cat /proc/cmdline | \
	    tr ' ' '\n' | \
	    sed 's/^ldap1=/ldap1#/' | \
	    awk -F'#' ' /^ldap1#/ { print \$2 }')
LDAP2=\$(cat /proc/cmdline | \
	    tr ' ' '\n' | \
	    sed 's/^ldap2=/ldap2#/' | \
	    awk -F'#' ' /^ldap2#/ { print \$2 }')

# Spawn x11vnc
# x11vnc -wait 50 -passwd PASSWORD -forever -loop -display :0 -o /var/log/x11vnc.log &
# 
# This runs as user, so cannot write to /var/log - thus you should use this instead:
# x11vnc -wait 50 -passwd PASSWORD -forever -loop -display :0 &
# 
# Spawning x11vnc here is a really, really dumb idea, as VNC has no way of using
# a public/private key pair, only passwords - and these must be stored in plain
# text somewhere, in a place that is actually world-readable. 
#
# /!\ This is about as dumb as shouting your root password in a room full of strangers! /!\
#
# A much, much better, safer and saner way to handle this is to enable the
# SSH daemon on the thinclient, supply it with an authorized_keys file containing
# a public key, and spawning x11vnc on demand after logging in - binding it to
# localhost only, and forwarding the port through your SSH connection.
#
# In short, run this on your local admin workstation:
# ssh -t -L 5900:localhost:5900 name_or_ip_of_thinclient 'x11vnc -localhost -display :0'
# and while this connection is active, run:
# vncviewer localhost:0


# Spawn X2GoClient
if [ -n "\$BROKERURL" ]; then
	SESSIONFROM="--broker-url=\$BROKERURL"
else 
	SESSIONFROM="--session-conf=/etc/x2go/x2gothinclient_sessions"
fi
if [ -n "\$LDAP" ] ; then
	if [ -n "\$LDAP1" ] ; then
		BACKUPLDAP="--ldap1=\$LDAP1"
		if [ -n "\$LDAP2" ] ; then
			BACKUPLDAP="\$BACKUPLDAP --ldap2=\$LDAP2"
		fi
	fi
	LDAPPARAMS="--ldap=\$LDAP \$BACKUPLDAP"
else
	LDAPPARAMS=""
fi
 
x2goclient --thinclient --no-session-edit --no-menu --maximize --add-to-known-hosts --haltbt \$LDAPPARAMS \$SESSIONFROM
XSESSION

chown user:user /home/user/.xsession
chmod 644 /home/user/.xsession

}

X2GoThinClientConfig
